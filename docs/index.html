<!DOCTYPE html>

<html>
<head>
  <title>index.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>index.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-pi">'use strict'</span>;

<span class="hljs-keyword">var</span> flxRepo = {},
    hooks;</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h1 id="fluxionnal-execution-model">Fluxionnal execution model</h1>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h2 id="fluxions">Fluxions</h2>

            </div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>The fluxionnal execution model role is to manage and invoke autonomous execution units.
An execution unit accepts only streams as input and output, that is a continuous and infinite sequence of data contained in messages.
We named this execution unit a fluxion.</p>

            </div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Messages are composed of the name of the recipient fluxion, a body, and are carried by a messaging system.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-comment">/**
 * Build a message
 * @param      {String}   destination name
 * @param      {Object}   body of the message
 * @return     {undefined} nothing
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">message</span><span class="hljs-params">(dest, body)</span> </span>{
  <span class="hljs-keyword">return</span> {
    dest: dest,
    body: body
  };
}</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>A fluxion is a function, as in functional programming, only dependent from data streams.
It is composed of a unique name, a processing function, and a persisted memory context.</p>

            </div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>While processing a message, the fluxion modifies its context, and sends back messages on its output streams.
The fluxion’s execution context is defined as the set of state variables whose the fluxion depends on, between two rounds of execution.</p>

            </div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>The fluxions make up a chain of processing binded by data streams.
All these chains make up a directed graph, managed by the messaging system.</p>

            </div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <h2 id="messaging-system">Messaging system</h2>

            </div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>The messaging system is the core of our fluxionnal execution model.
It carries messages along stream, and invokes fluxion at a message reception.</p>

            </div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>It is built around a message queue.
Each message is processed one after another by invocation of the recipient fluxion.
Using a message queue allows to execute multiple processing chain fairly and concurrently, without difference in scheduling local messages, or network messages.</p>

            </div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>The messaging system needs every fluxion to be registered.
This registration matchs a processing function with a unique name and an initial execution context.
The messaging system carries messages streams based on the names of the recipients fluxions.
That’s why two fluxions with the same name would lead the system in a conflicting situation.
The registration is done using the function <code>register(&lt;name&gt;, &lt;fn&gt;, &lt;context&gt;)</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-comment">/**
 * Register a fluxion
 * @param      {String}   Name
 * @param      {Function} Function
 * @param      {Object}   Scope
 * @return     {undefined} true if successuflly registered, false else.
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">register</span><span class="hljs-params">(name, fn, scp)</span> </span>{
  <span class="hljs-keyword">if</span> (flxRepo[name])
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

  scp = scp || {};
  scp.m = message;
  scp.register = register;

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> fn === <span class="hljs-string">'function'</span>) {
    hooks.register(name, fn, scp);
    flxRepo[name] = {run: fn, scp: scp}; 

    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>To trigger a fluxions chain, a message is sent using <code>start(&lt;msg&gt;)</code>, an alias for <code>post(&lt;msg&gt;)</code>, with a different meaning.
This function pushes a first message in the queue.
Immediately, the system dequeues this message to invoke the recipient processing function.
The recipient function sends back messages using <code>post(&lt;msg&gt;)</code>, to be enqueud in the system.
The system loops until the queue is empty.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-comment">/**
 * Post a message.
 * A message being an object containing the name of the destination fluxion, and the body of the message.
 * @param      {Object}   source path
 * @return     {undefined} nothing
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">post</span><span class="hljs-params">(msg)</span> </span>{

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">postMsg</span><span class="hljs-params">(msg)</span> </span>{
    <span class="hljs-keyword">if</span> (!msg)
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

    setImmediate(post, msg);
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">recvMsg</span><span class="hljs-params">(msg)</span> </span>{
    <span class="hljs-keyword">if</span> (!flxRepo[msg.dest]) {
      <span class="hljs-keyword">throw</span> <span class="hljs-string">'flx '</span> + msg.dest + <span class="hljs-string">' not defined'</span>;
    }

    hooks.post(msg, msg.dest);
    postMsg(flxRepo[msg.dest].run.call(flxRepo[msg.dest].scp, msg.body));
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p><code>post</code> accept messages with only one destination, or an array of destination to send the message to.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (msg)
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Array</span>.isArray(msg.dest)) {
      msg.dest.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(dest)</span> </span>{
        recvMsg(message(dest, msg.body));
      })
    } <span class="hljs-keyword">else</span> {
      recvMsg(msg);
    }
}</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <h1 id="hooks">Hooks</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">try</span> {
  hooks = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./hooks'</span>);
} <span class="hljs-keyword">catch</span>(err) {
  hooks = {
    register: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(name, fn, scps)</span> </span>{
    },
    post: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(msg, dest)</span> </span>{
    }
  };
}</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <h1 id="public-api">Public API</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-built_in">module</span>.exports = {
  register : register,
  post : post,
  start : post,
  m : message,
};</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
